#!/usr/bin/env bash
# This script is triggered on every new PR (see netlify.toml for details)
# It will create a live preview of the PR
#
# Note: Check the following link for a list of available environment variables:
# https://www.netlify.com/docs/continuous-deployment/#build-environment-variables
set -x

# Add the git remote in case it does not exist (can be deleted between caches)
if ! git config remote.origin.url > /dev/null; then
  git remote add origin https://github.com/algolia/docsearch.git
fi

# Make sure we have the latest version of master
git fetch origin master

# If no changes in the ./docs folder, we deploy a simple page
if ! git diff --name-only origin/master | grep -q '^docs/'; then
  mkdir -p ./dist
  echo "No deploy preview available as this PR does not change the documentation." > ./dist/index.html
  exit 0
fi

# We create a branch where we are to be able to get back to it later
git branch -d "preview" &>/dev/null
git checkout -b "preview"

# We create a tmp folder where we'll copy our content
mkdir -p ./tmp
rm -rf ./tmp/*

# We build the website and store it
cd ./docs || return
yarn run build
mv ./dist ../tmp/preview

# We go back on master and build the current version
git checkout master
yarn install
pwd
yarn run build
mv ./dist ../tmp/production
which diff2html

# We go back on our branch and compare the two
git checkout "preview"
diff -ur ../tmp/production ../tmp/preview \
  | diff2html --input stdin --output stdout \
  > ../tmp/preview/diff.html
mv ../tmp/preview ./dist
